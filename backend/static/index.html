<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL Detector | AI Powered</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        bg: "#020617",       // Darkest Blue/Black
                        surface: "#0f172a",  // Surface Slate
                        primary: "#2dd4bf",  // Teal 400
                        primaryHover: "#14b8a6", // Teal 500
                        secondary: "#94a3b8", // Slate 400
                        danger: "#ef4444",   // Red 500
                        success: "#10b981",  // Emerald 500
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Axios -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <style>
        body {
            background-color: #020617;
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
            margin: 0;
            min-height: 100vh;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 1rem;
        }

        /* Animation for result card entry */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slide-down {
            animation: slideDown 0.4s ease-out forwards;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { createRoot } = ReactDOM;

        // --- Utils ---
        const timeAgo = (dateString) => {
            if (!dateString) return "";
            // Append 'Z' to treat as UTC if missing, assuming backend sends UTC string without Z
            const dateStr = dateString.endsWith('Z') ? dateString : dateString + 'Z';
            const date = new Date(dateStr);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);

            if (seconds < 60) return "Just now";
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            const days = Math.floor(hours / 24);
            return `${days} day${days > 1 ? 's' : ''} ago`;
        };

        const formatDate = (dateString) => {
            const dateStr = dateString.endsWith('Z') ? dateString : dateString + 'Z';
            return new Date(dateStr).toLocaleString();
        };

        const copyToClipboard = (text) => {
            navigator.clipboard.writeText(text);
        };

        const exportToCSV = (data) => {
            if (!data || !data.length) return;
            const headers = ["Timestamp", "URL", "Status", "Confidence", "Analysis"];
            const csvContent = "data:text/csv;charset=utf-8,"
                + headers.join(",") + "\n"
                + data.map(row => {
                    return `"${row.timestamp}","${row.url}","${row.status}","${row.confidence}","${(row.analysis || "").replace(/"/g, '""')}"`;
                }).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "scan_history.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        const extractFeatures = (url) => {
            return {
                length: url.length,
                digits: (url.match(/\d/g) || []).length,
                hasHttps: url.toLowerCase().startsWith('https') ? 'Yes' : 'No'
            };
        };

        // --- Icons ---
        const Icons = {
            Shield: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12" /></svg>,
            Link: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" /><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" /></svg>,
            Search: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /></svg>,
            Refresh: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.5 2v6h-6" /><path d="M2.5 22v-6h6" /><path d="M2 11.5a10 10 0 0 1 18.8-4.3L22 10" /><path d="M22 12.5a10 10 0 0 1-18.8 4.2L2 12" /></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></svg>,
            Copy: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2" /><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" /></svg>,
            External: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" /><polyline points="15 3 21 3 21 9" /><line x1="10" y1="14" x2="21" y2="3" /></svg>,
            Pulse: () => <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12" /></svg>,
            ChevronDown: ({ classes }) => <svg className={classes} xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9" /></svg>,
            ChevronUp: ({ classes }) => <svg className={classes} xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="18 15 12 9 6 15" /></svg>,
        };

        // --- Result Card Component (Inline) ---
        const ResultCard = ({ result }) => {
            const [openSection, setOpenSection] = useState('explanation');
            const features = extractFeatures(result.url);

            return (
                <div className="w-full max-w-2xl mt-8 animate-slide-down border border-primary/20 rounded-2xl p-6 bg-surface/50 shadow-2xl relative overflow-hidden">
                    {/* Status Header */}
                    <div className="flex items-center space-x-4 mb-6">
                        <div className={`p-3 rounded-xl ${result.status === 'Safe' ? 'bg-success/20 text-success' : 'bg-danger/20 text-danger'}`}>
                            <Icons.Shield />
                        </div>
                        <div>
                            <div className={`px-3 py-1 rounded-full text-sm font-bold w-fit mb-1 ${result.status === 'Safe' ? 'bg-success text-bg' : 'bg-danger text-bg'}`}>
                                {result.status}
                            </div>
                            <p className="text-secondary text-sm">Analysis complete</p>
                        </div>
                    </div>

                    {/* URL Bar */}
                    <div className="flex items-center justify-between bg-bg p-4 rounded-xl border border-white/5 mb-6">
                        <span className="text-white truncate flex-1 font-mono text-sm">{result.url}</span>
                        <div className="flex space-x-3 ml-4 text-secondary">
                            <button onClick={() => copyToClipboard(result.url)} className="hover:text-primary"><Icons.Copy /></button>
                            <a href={result.url} target="_blank" className="hover:text-primary"><Icons.External /></a>
                        </div>
                    </div>

                    {/* Confidence */}
                    <div className="mb-6">
                        <div className="flex justify-between mb-2">
                            <span className="text-secondary text-sm">Confidence</span>
                            <span className="text-white font-bold">{(result.confidence * 100).toFixed(0)}%</span>
                        </div>
                        <div className="h-2 bg-bg rounded-full overflow-hidden">
                            <div
                                className={`h-full ${result.status === 'Safe' ? 'bg-success' : 'bg-danger'}`}
                                style={{ width: `${result.confidence * 100}%` }}
                            ></div>
                        </div>
                    </div>

                    {/* Accordions */}
                    <div className="space-y-3">
                        {/* Explanation */}
                        <div className="bg-white/5 rounded-xl overflow-hidden">
                            <button onClick={() => setOpenSection(openSection === 'explanation' ? '' : 'explanation')} className="w-full flex justify-between items-center p-4 text-left">
                                <span className="font-semibold text-sm text-slate-300">Explanation</span>
                                {openSection === 'explanation' ? <Icons.ChevronUp classes="text-secondary" /> : <Icons.ChevronDown classes="text-secondary" />}
                            </button>
                            {openSection === 'explanation' && (
                                <div className="px-4 pb-4 text-sm text-secondary leading-relaxed border-t border-white/5 pt-3">
                                    {result.analysis}
                                </div>
                            )}
                        </div>

                        {/* Raw Features */}
                        <div className="bg-white/5 rounded-xl overflow-hidden">
                            <button onClick={() => setOpenSection(openSection === 'features' ? '' : 'features')} className="w-full flex justify-between items-center p-4 text-left">
                                <span className="font-semibold text-sm text-slate-300">Raw Features</span>
                                {openSection === 'features' ? <Icons.ChevronUp classes="text-secondary" /> : <Icons.ChevronDown classes="text-secondary" />}
                            </button>
                            {openSection === 'features' && (
                                <div className="px-4 pb-4 text-sm text-secondary border-t border-white/5 pt-3 grid grid-cols-3 gap-4">
                                    <div>
                                        <span className="block text-xs uppercase opacity-70 mb-1">Url Length</span>
                                        <span className="font-mono text-white">{features.length}</span>
                                    </div>
                                    <div>
                                        <span className="block text-xs uppercase opacity-70 mb-1">Count Digits</span>
                                        <span className="font-mono text-white">{features.digits}</span>
                                    </div>
                                    <div>
                                        <span className="block text-xs uppercase opacity-70 mb-1">Has Https</span>
                                        <span className="font-mono text-white">{features.hasHttps}</span>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Dashboard View ---
        const DashboardView = ({ setView }) => {
            const [url, setUrl] = useState('');
            const [loading, setLoading] = useState(false);
            const [result, setResult] = useState(null);

            const handleScan = async (e) => {
                e.preventDefault();
                if (!url) return;
                setLoading(true);
                setResult(null);
                try {
                    const response = await axios.post('/scan', { url });
                    setResult(response.data);
                } catch (err) {
                    alert("Scan failed. Check backend.");
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-[80vh] w-full max-w-4xl mx-auto px-4 pb-20">
                    <div className="mb-8 p-4 bg-surface/50 rounded-2xl border border-white/5 shadow-2xl mt-10">
                        <div className="w-12 h-12 bg-surface border border-primary/20 rounded-xl flex items-center justify-center mx-auto text-primary mb-4 shadow-lg shadow-primary/10">
                            <Icons.Shield />
                        </div>
                        <h1 className="text-4xl md:text-5xl font-bold text-center text-white mb-2">Check URL Safety</h1>
                        <p className="text-center text-secondary">
                            Enter any URL to analyze its safety using AI-powered detection.<br />
                            Get instant results with confidence scores and detailed explanations.
                        </p>
                    </div>

                    <div className="w-full max-w-2xl">
                        <form onSubmit={handleScan} className="bg-surface p-2 rounded-xl border border-white/10 flex items-center shadow-lg">
                            <div className="pl-4 text-secondary">
                                <Icons.Link />
                            </div>
                            <input
                                type="text"
                                value={url}
                                onChange={(e) => setUrl(e.target.value)}
                                placeholder="https://example.com"
                                className="flex-1 bg-transparent border-none outline-none text-white px-4 py-3 placeholder-slate-700"
                            />
                            <button
                                type="submit"
                                disabled={loading}
                                className="bg-primary hover:bg-primaryHover text-slate-900 font-bold py-2 px-6 rounded-lg transition-colors flex items-center space-x-2 shrink-0"
                            >
                                {loading ? <span>...</span> : <><Icons.Search /> <span>Check URL</span></>}
                            </button>
                        </form>
                    </div>

                    {/* Inline Result */}
                    {result && <ResultCard result={result} />}

                    {/* Features Grid (Only show if no result is there, to keep UI clean, or force keep it below? User wants result in bottom. Let's push grid down/hide it) */}
                    {!result && (
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 w-full mt-16 max-w-4xl">
                            {[
                                { title: "AI Analysis", desc: "Machine learning models trained on millions of URLs" },
                                { title: "Instant Results", desc: "Get safety scores in seconds with detailed explanations" },
                                { title: "History Tracking", desc: "All analyzed URLs are saved for future reference" }
                            ].map((item, idx) => (
                                <div key={idx} className="bg-surface/30 p-6 rounded-xl border border-white/5 hover:border-primary/30 transition-colors text-center">
                                    <h3 className="text-white font-semibold mb-2">{item.title}</h3>
                                    <p className="text-sm text-secondary">{item.desc}</p>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- History View ---
        const HistoryView = () => {
            const [data, setData] = useState([]);
            const [expandedRow, setExpandedRow] = useState(null);

            const fetchHistory = async () => {
                try {
                    const res = await axios.get('/history?limit=50');
                    setData(res.data);
                } catch (e) { console.error(e); }
            };

            useEffect(() => { fetchHistory(); }, []);

            const toggleRow = (idx) => {
                setExpandedRow(expandedRow === idx ? null : idx);
            };

            return (
                <div className="max-w-6xl mx-auto px-4 py-10">
                    <div className="text-center mb-10">
                        <div className="w-16 h-16 bg-surface border border-white/10 rounded-2xl flex items-center justify-center mx-auto text-primary mb-4 shadow-lg shadow-primary/20">
                            <Icons.Pulse />
                        </div>
                        <h2 className="text-3xl font-bold text-white mb-2">Analysis History</h2>
                        <p className="text-secondary">View and export your URL analysis history.</p>
                    </div>

                    <div className="glass-panel p-1">
                        <div className="flex justify-between items-center p-4 border-b border-white/5 bg-surface/50 rounded-t-lg">
                            <div className="flex space-x-2">
                                <button onClick={fetchHistory} className="flex items-center space-x-2 px-4 py-2 bg-white/5 hover:bg-white/10 rounded-lg text-sm text-white transition-colors border border-white/5">
                                    <Icons.Refresh /> <span>Refresh</span>
                                </button>
                                <button onClick={() => exportToCSV(data)} className="flex items-center space-x-2 px-4 py-2 bg-white/5 hover:bg-white/10 rounded-lg text-sm text-white transition-colors border border-white/5">
                                    <Icons.Download /> <span>Export CSV</span>
                                </button>
                            </div>
                            <div className="flex items-center space-x-2 text-sm text-secondary">
                                <span>Show</span>
                                <span className="text-white font-bold">50</span>
                                <span>entries</span>
                            </div>
                        </div>

                        <div className="overflow-x-auto">
                            <table className="w-full text-left border-collapse">
                                <thead className="bg-bg text-secondary text-xs uppercase font-semibold">
                                    <tr>
                                        <th className="px-6 py-4">Time</th>
                                        <th className="px-6 py-4">URL</th>
                                        <th className="px-6 py-4">Status</th>
                                        <th className="px-6 py-4">Confidence</th>
                                        <th className="px-6 py-4 text-right">Details</th>
                                    </tr>
                                </thead>
                                <tbody className="text-sm text-slate-300">
                                    {data.map((row, i) => (
                                        <React.Fragment key={i}>
                                            <tr className={`hover:bg-white/5 transition-colors border-b border-white/5 ${expandedRow === i ? 'bg-white/5' : ''}`}>
                                                <td className="px-6 py-4 whitespace-nowrap text-secondary font-mono text-xs">{timeAgo(row.timestamp)}</td>
                                                <td className="px-6 py-4">
                                                    <div className="flex items-center space-x-2 max-w-sm">
                                                        <span className="truncate">{row.url}</span>
                                                    </div>
                                                </td>
                                                <td className="px-6 py-4">
                                                    <span className={`px-3 py-1 rounded-full text-xs font-bold ${row.status === 'Safe'
                                                            ? 'bg-success/10 text-success border border-success/20'
                                                            : 'bg-danger/10 text-danger border border-danger/20'
                                                        }`}>
                                                        {row.status}
                                                    </span>
                                                </td>
                                                <td className="px-6 py-4 w-48">
                                                    <div className="flex items-center space-x-3">
                                                        <div className="flex-1 h-1.5 bg-bg rounded-full overflow-hidden">
                                                            <div
                                                                className={`h-full ${row.status === 'Safe' ? 'bg-success' : 'bg-danger'}`}
                                                                style={{ width: `${row.confidence * 100}%` }}
                                                            ></div>
                                                        </div>
                                                        <span className="text-xs font-mono">{(row.confidence * 100).toFixed(0)}%</span>
                                                    </div>
                                                </td>
                                                <td className="px-6 py-4 text-right">
                                                    <button
                                                        onClick={() => toggleRow(i)}
                                                        className="text-primary hover:text-primaryHover text-xs font-semibold flex items-center justify-end space-x-1 ml-auto"
                                                    >
                                                        <span>{expandedRow === i ? "Hide" : "Show"}</span>
                                                        {expandedRow === i ? <Icons.ChevronUp classes="w-4 h-4" /> : <Icons.ChevronDown classes="w-4 h-4" />}
                                                    </button>
                                                </td>
                                            </tr>
                                            {expandedRow === i && (
                                                <tr className="bg-bg/50">
                                                    <td colSpan="5" className="px-6 py-6 text-sm">
                                                        <div className="grid gap-6">
                                                            <div>
                                                                <h4 className="text-xs uppercase text-secondary font-semibold mb-2">Explanation</h4>
                                                                <p className="text-slate-300 leading-relaxed bg-surface p-4 rounded-lg border border-white/5">{row.analysis}</p>
                                                            </div>
                                                            <div>
                                                                <h4 className="text-xs uppercase text-secondary font-semibold mb-2">Full URL</h4>
                                                                <code className="block bg-black p-3 rounded text-primary font-mono text-xs break-all">{row.url}</code>
                                                            </div>
                                                            <div>
                                                                <h4 className="text-xs uppercase text-secondary font-semibold mb-1">Timestamp</h4>
                                                                <span className="text-slate-400">{formatDate(row.timestamp)}</span>
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            )}
                                        </React.Fragment>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App Shell ---
        const App = () => {
            const [view, setView] = useState('dashboard');

            return (
                <div className="min-h-screen bg-bg">
                    {/* Header */}
                    <nav className="border-b border-white/5 bg-bg/80 backdrop-blur-md sticky top-0 z-40">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
                            <div className="flex items-center space-x-3">
                                <div className="text-primary"><Icons.Shield /></div>
                                <div>
                                    <h1 className="text-white font-bold text-lg leading-none">URL Detector <span className="text-primary">Dashboard</span></h1>
                                    <span className="text-xs text-secondary">AI-powered URL safety analysis</span>
                                </div>
                            </div>

                            <div className="flex items-center space-x-4">
                                <div className="bg-surface p-1 rounded-lg border border-white/5 flex">
                                    <button
                                        onClick={() => setView('dashboard')}
                                        className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${view === 'dashboard' ? 'bg-primary text-slate-900 shadow-lg shadow-primary/20' : 'text-secondary hover:text-white'}`}
                                    >
                                        Check URL
                                    </button>
                                    <button
                                        onClick={() => setView('history')}
                                        className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${view === 'history' ? 'bg-primary text-slate-900 shadow-lg shadow-primary/20' : 'text-secondary hover:text-white'}`}
                                    >
                                        History
                                    </button>
                                </div>
                            </div>
                        </div>
                    </nav>

                    <main className="py-8">
                        {view === 'dashboard' ? <DashboardView setView={setView} /> : <HistoryView />}
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>